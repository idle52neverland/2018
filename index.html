<script>
  function openVideo(url) {
    const videoId = new URL(url).searchParams.get("v");
    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
    localStorage.setItem("activeVideo", embedUrl);
    document.getElementById("videoPlayerFrame").src = embedUrl;
    document.getElementById("videoPlayerContainer").style.display = "flex";
  }

  function closeVideoPlayer() {
    localStorage.removeItem("activeVideo");
    document.getElementById("videoPlayerFrame").src = "";
    document.getElementById("videoPlayerContainer").style.display = "none";
  }

  document.addEventListener("DOMContentLoaded", function () {
    const all = allCards || [];
    const container = document.getElementById("allCards");
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const searchInput = document.getElementById("searchInput");
    let currentIndex = 0;
    const batchSize = 30;

    // 모바일 대응 iframe 높이 조정
    const style = document.createElement('style');
    style.innerHTML = `@media (max-width: 768px) {
      .video-player-container iframe {
        height: 220px;
      }
    }`;
    document.head.appendChild(style);

    // 페이지 복귀 시 영상 유지
    const savedVideo = localStorage.getItem("activeVideo");
    if (savedVideo) {
      document.getElementById("videoPlayerFrame").src = savedVideo;
      document.getElementById("videoPlayerContainer").style.display = "flex";
    }

    function extractDateFromTitle(title) {
      const match = title.match(/\((\d{4}-\d{2}-\d{2})\)/);
      return match ? match[1] : "2000-01-01";
    }

    all.sort((a, b) => {
      const dateA = extractDateFromTitle(a.title);
      const dateB = extractDateFromTitle(b.title);
      return new Date(dateB) - new Date(dateA);
    });

    function renderCards(cards = all.slice(currentIndex, currentIndex + batchSize)) {
      cards.forEach(data => {
        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute("data-category", data.category);
        card.setAttribute("data-member", data.member);
        card.setAttribute("data-year", data.year);
        card.addEventListener("click", () => openVideo(data.link));
        card.innerHTML = `
          <img src="${data.thumbnail}" alt="${data.alt}">
          <div class="card-title">${data.title}</div>
        `;
        container.appendChild(card);
      });
      currentIndex += batchSize;
      loadMoreBtn.style.display = currentIndex >= all.length ? "none" : "block";
    }

    renderCards();
    loadMoreBtn.addEventListener("click", () => renderCards());
    searchInput.addEventListener("input", function () {
      const keyword = this.value.toLowerCase();
      const filtered = all.filter(card => card.title.toLowerCase().includes(keyword));
      container.innerHTML = "";
      currentIndex = 0;
      renderCards(filtered);
    });
  });

  // 영상 자동 꺼짐 (페이지 벗어날 때)
  window.addEventListener("beforeunload", () => {
    localStorage.removeItem("activeVideo");
  });
</script>
